<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta charset="utf-8">
    <link href="AMLclassifiers_files/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="styling/sydney-fonts.css" type="text/css" />
    <link rel="stylesheet" href="styling/sydney.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">


class: title-slide
background-image: url("styling/USydLogo-black.svg"), url("styling/title-image1.jpg")
background-position: 10% 90%, 100% 50%
background-size: 160px, 100% 100%

.content-box-purple[
# .black[Activity 1]
## Selecting Biomarkers and Making Predictions of Treatment Resistance
### Ellis Patrick
### 29 June 2018
]

---

## Activity Overview

- RNA-seq Data Set: Acute Myeloid Leukaemia Treatment Resistance

--

- ClassifyR: Biomarker Selection Methods and Cross-validation

--

- Differential Means and Differential Distribution Classifiers for Classifying AML Patients

---

## RNA-seq Data Set: Acute Myeloid Leukaemia (AML) Treatment Resistance

- Primary therapy resistance is a major problem in acute myeloid leukemia treatment. Approximately 20â€“30% of younger adult patients with AML and as many as 50% of older adults are refractory to induction treatment.

--

- Research findings are &lt;a href="http://www.haematologica.org/content/103/3/456" target="_blank"&gt;published&lt;/a&gt; in *Haematologica* in 2018.

--

- The data is available from &lt;a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE106291" target="_blank"&gt;GEO Browser&lt;/a&gt; as 250 `txt.gz` files of gene-level read counts or a Microsoft Excel file where the gene expression values were standardised to have a mean of 0 and variance of 1.

--



Import the prepared tab-separated text files of RNA-seq read counts and clinical data.


```r
readCounts &lt;- read.delim("data/counts.txt", check.names = FALSE)
readCounts &lt;- as.matrix(readCounts)
sampleInfo &lt;- read.delim("data/samples.txt", check.names = FALSE)
```

---

## Clinical Data

The cinical data provides information about seven different characteristics of the patients.



```r
head(sampleInfo)
```

```
##       ID Gender Age  Response Survival Time Status RUNX1-RUNX1T1 Fusion RUNX1 Mutation
## 1 GEO-13   Male  47 Resistant            32   Dead                   No            Yes
## 2 GEO-14   Male  38 Resistant           125   Dead                   No            Yes
## 3 GEO-15 Female  38 Resistant             1   Dead                   No            Yes
## 4 GEO-16   Male  37 Resistant            18   Dead                   No            Yes
## 5 GEO-17   Male  33 Resistant           143   Dead                   No             No
## 6 GEO-18   Male   7 Resistant           127  Alive                   No            Yes
```

```r
nrow(sampleInfo)
```

```
## [1] 250
```

---

## Clinical Data

Observe the number of samples which are resistant to treatment and which are not.


```r
table(sampleInfo[, "Response"])
```

```
## 
## Resistant Sensitive 
##        71       164
```

--

`\(164 + 71 = 235\)`, so there are 15 patients with missing data regarding their resistance. Identify which rows of the clinical data they are in.


```r
removeClinical &lt;- which(is.na(sampleInfo[, "Response"]))
```

---

## AML Read Counts


```r
dim(readCounts)
```

```
## [1] 23367   250
```

There are 23367 genes in the counts table and 250 AML patients.

--


```r
readCounts[1:6, 1:6]
```

```
##          GEO-13 GEO-14 GEO-15 GEO-16 GEO-17 GEO-18
## A1BG        270     84     22    245    380    581
## A1BG-AS1     32     59      7     60    126     88
## A1CF          0      0      0      0      0      0
## A2LD1        14      4     18     19     35      1
## A2M          38      8     58    185      0     20
## A2ML1         0      0      1      0      0      0
```

---

## AML Read Counts

The number of reads per sample varies widely betwen patients by as much as 10-fold.


```r
samplesCounts &lt;- colSums(readCounts)
countsSummary &lt;- summary(samplesCounts)
countsSummary
```

```
##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
##  3427284  9198530 10865612 12365192 13335215 41850915
```

--

Identify in which columns of the matrix patients with less than the first quartile of counted reads and more than the third quartile are to remove them from the analysis.


```r
removeRNA &lt;- which(samplesCounts &lt; countsSummary["1st Qu."] |
                   samplesCounts &gt; countsSummary["3rd Qu."])
```

---

## Subsetting the Data Set

Remove samples which have a number of read counts below the first quartile of counted reads or above the third quartile as well as those missing resistance status.


```r
allRemove &lt;- union(removeClinical, removeRNA)
readCounts &lt;- readCounts[, -allRemove]
sampleInfo &lt;- sampleInfo[-allRemove, ]
```

--

Caclulate the number of remanining samples belonging to each class.


```r
classes &lt;- sampleInfo[, "Response"]
table(classes)
```

```
## classes
## Resistant Sensitive 
##        40        73
```

--

There is a moderate amount of class imbalance in this data set.

---

## Relationship of Mean and Variance

- RNA-seq count measurements are known to have a relationship between mean and variance.

--

- Many classification algorithms require data with constant variance over the range of means.

--

Scale each sample's counts to be the same as the sample in the first column.


```r
scaleFactors &lt;- colSums(readCounts)[1] / colSums(readCounts)
scaledCounts &lt;- t(t(readCounts) * scaleFactors)
```

---

## Relationship of Mean and Variance

Observe the mean-variance relationship.


```r
library(EDASeq)
AMLExpressionSet &lt;- newSeqExpressionSet(scaledCounts)
meanVarPlot(AMLExpressionSet, log = TRUE, main = "Mean-Variance Plot")
```

&lt;img src="AMLclassifiers_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;

---

## Relationship of Mean and Variance

Using DESeq2's `varianceStabilizingTransformation` function, remove the relationship of variance to mean.


```r
library(DESeq2)
measurementsVS &lt;- varianceStabilizingTransformation(readCounts)
normCounts(AMLExpressionSet) &lt;- measurementsVS
```

---

## Relationship of Mean and Variance

Visualise again the relationship between mean and variance.


```r
meanVarPlot(AMLExpressionSet, xlim = c(3, 9), ylim = c(0, 9), main = "Mean-Variance Plot")
```

&lt;img src="AMLclassifiers_files/figure-html/unnamed-chunk-15-1.png" style="display: block; margin: auto;" /&gt;

The variance is now reasonably constant across the range of means.

---

## Subsetting the Data Set Again

Before doing any classification, the number of genes will be reduced to make feature selection faster. The top 2000 most variable genes are retained.


```r
geneVariances &lt;- apply(measurementsVS, 1, var)
mostVariable &lt;- order(geneVariances, decreasing = TRUE)[1:2000]
measurementsVS &lt;- measurementsVS[mostVariable, ]
measurementsVS[1:6, 1:6]
```

```
##             GEO-13    GEO-14    GEO-15    GEO-16    GEO-19    GEO-23
## XIST      5.062396  5.178148 13.541422  9.188697  9.618966 11.462734
## RPS4Y1   12.325286 11.771083  4.549248 12.194969 10.613627 11.691603
## HLA-DQB1  4.904264  6.236311 12.780571  7.973863 11.617717  8.386216
## HBG2      5.062396  4.979277  9.263001 12.634407 12.693897 11.105495
## KDM5D    11.060686 10.000682  3.697632 10.991681  9.804978 10.061677
## THBS1     8.743274 11.188168 10.928276  9.001494  9.818238 10.756625
```

Class information is not used, so the filtering is fair. The most variable gene is XIST, a gene involved with X chromosome inactivation, a process by which one of the two copies of the X chromosome present in female mammals is inactivated.

---

## ClassifyR

- A *framework* for feature selection, cross-validated classification and its performance evaluation.

--

- Some popular feature selection methods and classifiers implemented in the package.
--

- Runs cross-validation in parallel on Windows, MacOS, Linux operating systems.

--

- Supports numeric-only (`matrix`) data, mixed numeric-categorical (`DataFrame`) data and multi-omics data (`MultiAssayExperiment`). 

--

- Continually maintained and supported (first released in 2014).

---

## Parameter Objects

- Each stage of classification is defined by a parameter object.

--

- The four main types of objects are `TransformParams`, `SelectParams`, `TrainParams` and `PredictParams`.

--

- `TransformParams` and `SelectParams` are optional.

---

## Getting Help Using ClassifyR

- Every Bioconductor package has a vignette which demonstrates the main usage on an example data set. ClassifyR's HTML vignette is available from the &lt;a href="https://bioconductor.org/packages/release/bioc/html/ClassifyR.html" target="_blank"&gt;package's home page&lt;/a&gt;.

- The &lt;a href="https://support.bioconductor.org/" target="_blank"&gt;Bioconductor Support Forum&lt;/a&gt; is the best communication channel to ask questions about packages.

---

## Cross-validation

- The process of creating many different training and test sets is handled by `runTests`.

--

- The `seed` option allows the specification of a number which results in cross-validations which rely on random splits to be reproduced if the code is rerun, even if it runs on multiple cores.

--

- The result of running `runTests` is a `ClassifyResult` object, which many performance evaluation functions use.

--

- A `ClassifyResult` object stores the class predictions and possibly also class scores as well as the features selected at each cross-validation iteration.

---

## Differential Means Classifier for AML Resistance

- The default feature selection method of `SelectParams` is a moderated t-test based ranking and selection of the top `\(p\)` genes that give the best resubstitution error (considering 10, 20, ..., 100 top-ranked features). See `?SelectParams` for the specification.

--

- The default training and prediction methods for `TrainParams` and `PredictParams` are for Diagonal Linear Discriminant Analysis (DLDA). See `?TrainParams` and `?PredictParams` for the specification.

---

## Differential Means (DM) Classifier for AML Resistance

Run 20 permutations and 5 folds cross-validation.

--


```r
library(ClassifyR)
```


```r
classifiedDM &lt;- runTests(measurementsVS, classes, "AML", "DLDA",
                         permutations = 20, seed = 2018)
classifiedDM
```

```
## An object of class 'ClassifyResult'.
## Data Set Name: AML.
## Classification Name: DLDA.
## Feature Selection Name: Limma moderated t-test.
## Features: List of length 20 of lists of length 5 of feature identifiers.
## Validation: 20 Permutations, 5 Folds.
## Predictions: List of data frames of length 20.
## Performance Measures: None calculated yet.
```

---

## Parallel Processing

- By default, 2 less cores than the computer has are used.

- On Windows, use `parallelParams = SnowParam(workers = 8)` to use 8 cores and on Linux or MacOS use `parallelParams = MulticoreParam(workers = 8)` as an arguent to `runTests` to achieve the same customisation.

---

## Accessing the Chosen Features

- Rarely done directly by you.
- The `features` accessor extracts all of the feature selections at each iteration of cross-validation.


```r
# Permutation 1, folds 1 and 2.
features(classifiedDM)[[1]][1:2]
```

```
## [[1]]
##  [1] "BEND4"     "INHBA"     "LSP1"      "BAIAP2"    "IL1R1"     "SLA"       "PLAUR"    
##  [8] "ALDH2"     "ADAMTS10"  "HIST3H2A"  "SCRN1"     "CCNA1"     "SOD2"      "SH3PXD2B" 
## [15] "SLITRK5"   "ID2"       "LOC728606" "LAMP5"     "PSD3"      "ZNF135"    "HIST2H2BE"
## [22] "BCL11B"    "CAMK4"     "SH3BP5"    "PBX3"      "HMGA2"     "ZMAT1"     "IRAK2"    
## [29] "CDK6"      "HIST2H2BF"
## 
## [[2]]
##  [1] "BEND4"     "SH3BP5"    "LOC728606" "LSP1"      "INHBA"     "DDIT4L"    "ADORA2B"  
##  [8] "LILRA5"    "CDK6"      "CYYR1"
```

---

## Accessing the Predictions

- The `predictions` accessor gets all of the class predictions.


```r
# Permutation 1
head(predictions(classifiedDM)[[1]])
```

```
##    sample     class
## 1  GEO-96 Resistant
## 2  GEO-85 Resistant
## 3 GEO-101 Sensitive
## 4 GEO-154 Sensitive
## 5  GEO-64 Sensitive
## 6 GEO-113 Sensitive
```

---

## Most Frequently Selected Feature

The `distribution` function calculates the feature selection frequency of all features.


```r
frequencies &lt;- distribution(classifiedDM, plot = FALSE)
frequencies &lt;- sort(frequencies, decreasing = TRUE)
head(frequencies)
```

```
## allFeatures
##     BEND4     INHBA      LSP1 LOC728606      SOD2  ADAMTS10 
##       100        92        83        76        69        64
```

BEND4 is chosen 100 out of 100 possible times.

---

## Most Frequently Selected Feature

The distribution of gene expression per class can be quickly visualised with `plotFeatureClasses`.


```r
plotFeatureClasses(measurementsVS, classes, targets = names(frequencies)[1],
                   whichNumericPlots = "density", xAxisLabel = "RNA-seq Abundance")
```

&lt;img src="AMLclassifiers_files/figure-html/unnamed-chunk-22-1.png" style="display: block; margin: auto;" /&gt;

The gene is visibly differentially expressed between resistant and sensitive patients.

---

## Clinical Data Quality Check

ZFY is a gene on the Y chromosome which only males have. Plot its expression with the gender in place of the treatment resistance classes.


```r
plotFeatureClasses(measurementsVS, sampleInfo[, "Gender"], targets = "ZFY",
                   whichNumericPlots = "density", xAxisLabel = "RNA-seq Abundance")
```

&lt;img src="AMLclassifiers_files/figure-html/unnamed-chunk-23-1.png" style="display: block; margin: auto;" /&gt;

The abundance grouped by gender is as expected.

---


## Differential Distribution (DD) Classifier for AML Resistance

Both changes in means and changes in variances can be useful for making class predictions.

.center[![](images/diffDist.svg)]

---

## DD Feature Selection Setup

Numerous DD selection methods are available in ClassifyR. &lt;a href="https://bioconductor.org/packages/release/bioc/vignettes/ClassifyR/inst/doc/ClassifyR.html#provided-feature-selection-and-classification-methods" target="_blank"&gt;Section 0.9 of the vignette&lt;/a&gt; gives an overview. For this example, Kullback-Leibler divergence will be used.

--

Navigate to the Reference Manual (PDF) of &lt;a href="https://bioconductor.org/packages/release/bioc/html/ClassifyR.html" target="_blank"&gt;ClassifyR&lt;/a&gt; to see the formula.

--


```r
selectParams &lt;- SelectParams(KullbackLeiblerSelection,
                             resubstituteParams = ResubstituteParams())
```

By default, the mean is the location and the standard deviation is the scale.

---

## DD Classifier Setup

A variety of DD classifiers are available in ClassifyR. For this example, the naive Bayes method will be used. The difference of the height (scaled by the number of samples in each class) between the kernel densities of the two classes is used by each gene to vote for one class. The class with the most votes is the predicted class of the patient.


```r
trainParams &lt;- TrainParams(naiveBayesKernel)
```

--

`naiveBayesKernel` trains a classifier and returns a factor vector of class predictions, so there is no other function used for predictions.


```r
predictParams &lt;- PredictParams(NULL, weighted = "unweighted", weight = "height difference",
                               getClasses = function(result) result)
```

---

## DD Cross-validated Classification

As was done for DM classification, 20 permutations and 5 fold cross-validation is done.


```r
classifiedDD &lt;- runTests(measurementsVS, classes, "AML", "naive Bayes Voting",
*                        params = list(selectParams, trainParams, predictParams),
                         permutations = 20, seed = 2018)
classifiedDD
```

```
## An object of class 'ClassifyResult'.
## Data Set Name: AML.
## Classification Name: naive Bayes Voting.
## Feature Selection Name: Kullback-Leibler Divergence.
## Features: List of length 20 of lists of length 5 of feature identifiers.
## Validation: 20 Permutations, 5 Folds.
## Predictions: List of data frames of length 20.
## Performance Measures: None calculated yet.
```

---

## Logsitic Regression Classifier for AML Resistance

- Classifier built using only the routinely collected clinical information.

--

- *Multinomial* logistic regression is not available by default in R, but is available from mnlogit.

--

- `logisticRegressionTrainInterface` is a wrapper around the `mnlogit` fitting function.

--

- `logisticRegressionPredictInterface` is a wrapper around the `predict` function for objects of class `mnlogit`.

---

## Logsitic Regression Classifier for AML Resistance

Specify the training and prediction settings.


```r
trainParams &lt;- TrainParams(logisticRegressionTrainInterface)
predictParams &lt;- PredictParams(logisticRegressionPredictInterface,
                               getClasses = function(result) result)
```

Run 20 permutations and 5 folds cross-validation, ignoring GEO ID, Survival Time and Status.


```r
ignoreColumns &lt;- match(c("ID", "Survival Time", "Status"), colnames(sampleInfo))
ignoreColumns
```

```
## [1] 1 5 6
```

```r
classifiedClinical &lt;- runTests(DataFrame(sampleInfo[, -ignoreColumns]), "Response",
                               "AML", "Logistic Regression",
*                              params = list(trainParams, predictParams),
                               permutations = 20, seed = 2018)
```

---

## Logsitic Regression Classifier for AML Resistance


```r
classifiedClinical
```

```
## An object of class 'ClassifyResult'.
## Data Set Name: AML.
## Classification Name: Logistic Regression.
## Feature Selection Name: Unspecified.
## Features: All used.
## Validation: 20 Permutations, 5 Folds.
## Predictions: List of data frames of length 20.
## Performance Measures: None calculated yet.
```

---

## After the Break

- Evaluation of feature selection stability.

- Evaluation of overall error, sample-specific error, precision, recall.

- Comparison of the three different classifiers.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="styling/remark-zoom.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9",
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
